box: dosomething/ds-docker-php:ruby2.4

build:
    steps:
      - leipert/composer-install@0.9.1
      - wercker/npm-install
      - script:
          name: build front-end assets
          code: npm run build
      - script:
          name: start mysql
          code: sudo service mysql start
      - script:
          name: run phpunit test suite
          code: |-
            mysql -u homestead -psecret -e "CREATE DATABASE rogue_test;"
            cp .env.example .env
            php artisan key:generate
            vendor/bin/phpunit
            
      - internal/docker-push:
          entrypoint: bin/get_ip
          cmd: 0.0.0.0 9090
          working-dir: $WERCKER_ROOT
          tag: $WERCKER_GIT_COMMIT
          ports: "9090"
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
          repository: $DOCKERHUB_REPO
          registry: $GCR_HOST

deploy:
  steps:
    - bundle-install
    - script:
        name: write private key env var
        code: |-
          export CAP_PRIVATE_KEY=`mktemp`
          echo -e $WERCKER_APP_KEY_PRIVATE > $CAP_PRIVATE_KEY
    - script:
        name: Install cap requirements
        code: |-
          ruby -v
          gem install capistrano-npm
          gem install capistrano-composer
    - cap
    - heroku-deploy:
        key: $HEROKU_KEY
        key-name: HEROKU_KEY_PAIR
        user: $HEROKU_USER
        app-name: $HEROKU_APP_NAME
  # after-steps:
  #   - sherzberg/slack-notify:
  #       subdomain: dosomething
  #       token: $SLACK_TOKEN
  #       channel: $SLACK_ROOM
  #       TEST
